<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>KLSE + Moomoo Tools</title>
<style>
body{font-family:Arial,sans-serif;padding:20px;max-width:480px;margin:auto;color:#222;}
h2{margin-bottom:10px;}
h3{margin-top:25px;border-left:4px solid #555;padding-left:8px;}
label{font-size:14px;margin-top:6px;display:block;color:#444;}
input, select{width:100%;padding:8px;margin-top:4px;border:1px solid #bbb;border-radius:6px;font-size:15px;}
button{width:100%;padding:10px;margin-top:10px;background:#e9e9e9;border:1px solid #bbb;border-radius:6px;font-size:15px;cursor:pointer;}
button:hover{background:#dcdcdc;}
.result{background:#f5f5f5;border:1px solid #ddd;padding:10px;margin-top:12px;border-radius:6px;font-size:14px;white-space:pre-line;}
</style>
</head>
<body>

<h2>交易成本計算器</h2>

<h3>手續費計算</h3>
<label>模式</label>
<select id="feeMode">
  <option value="normal">普通马股</option>
  <option value="moomoo_my">moomoo 马股</option>
  <option value="moomoo_us">moomoo 美股（USD）</option>
</select>

<label>股價</label>
<input type="number" step="0.001" id="price">

<label>股數</label>
<input type="number" id="qty">

<label id="usdNote" style="display:none;color:#777;font-size:13px;">*美股按 USD 计算</label>

<button onclick="calcFee()">計算手續費</button>
<div id="feeOut" class="result"></div>

<h3>換手率</h3>
<label>成交量 (lot / 35M / 450K)</label>
<input type="text" id="vol">
<label>股本數 (10.79B / 5.8B)</label>
<input type="text" id="shares">
<button onclick="calcTurn()">計算換手率</button>
<div id="turnOut" class="result"></div>

<h3>止盈 / 止損 / RR</h3>
<label>預計買入價 (RM)</label>
<input type="number" step="0.001" id="entry">
<button onclick="calcRR()">計算</button>
<div id="rrOut" class="result"></div>

<script>
function parseNum(v){
  if(!v) return NaN;
  v = v.toString().trim().toUpperCase().replace(/,/g,"");
  let n = parseFloat(v);
  if(isNaN(n)) return NaN;
  if(v.endsWith("B")) return n*1e9;
  if(v.endsWith("M")) return n*1e6;
  if(v.endsWith("K")) return n*1e3;
  return n;
}
function formatNum(n){return n.toLocaleString('en-US');}

function feeNormal(a){let p=a>=3000?a*0.0042:12,c=a*0.0003,s=Math.ceil(a/1000)*1;return {p,c,s,total:p+c+s};}
function feeMoomooMY(a){let commission=Math.max(a*0.0003,3),clearing=Math.min(a*0.0003,1000),stamp=Math.min(Math.ceil(a/1000)*1,200);return {p:commission,c:clearing,s:stamp,total:commission+clearing+stamp};}

// Moomoo US
function feeMoomooUS(a){
  // a is USD amount
  let commission = Math.max(a*0.0003, 0.99);
  let platform   = 0.99;
  // Regulatory fees like SEC/TAF not included here for simplicity
  return {p:commission,c:platform,s:0,total:commission+platform};
}

function calcFee(){
  let price=parseFloat(document.getElementById("price").value);
  let qty=parseInt(document.getElementById("qty").value);
  let mode=document.getElementById("feeMode").value;
  if(!price||!qty)return;
  let amt = price * qty;
  let f;
  if(mode==="normal") f = feeNormal(amt);
  if(mode==="moomoo_my") f = feeMoomooMY(amt);
  if(mode==="moomoo_us"){
    f = feeMoomooUS(amt);
  }

  let txt = "";
  if(mode==="moomoo_us"){
    txt += `成交金额 (USD): $${amt.toFixed(2)}\n`;
    txt += `佣金 (USD): $${f.p.toFixed(2)}\n`;
    txt += `平台费 (USD): $${f.c.toFixed(2)}\n`;
    txt += `-------------------------\n`;
    txt += `总费用 (USD): $${f.total.toFixed(2)}`;
  } else {
    txt += `成交金额: RM ${amt.toFixed(2)}\n`;
    txt += `佣金: RM ${f.p.toFixed(2)}\n`;
    txt += `清算费: RM ${f.c.toFixed(2)}\n`;
    txt += `印花税: RM ${f.s.toFixed(2)}\n`;
    txt += `-------------------------\n`;
    txt += `总费用: RM ${f.total.toFixed(2)}`;
  }
  document.getElementById("feeOut").innerText = txt;
}

function calcTurn(){
  let v=parseNum(document.getElementById("vol").value);
  let s=parseNum(document.getElementById("shares").value);
  if(!v||!s)return;
  let volShares = v * 100;
  let t=(volShares/s*100);
  let display = t>=1?t.toFixed(2)+"%":t>=0.1?t.toFixed(3)+"%":t>=0.01?t.toFixed(4)+"%":t>=0.001?t.toFixed(5)+"%":t.toFixed(6)+"%";
  document.getElementById("turnOut").innerText=
`成交量(lot): ${formatNum(v)}
成交量(股): ${formatNum(volShares)}
股本數: ${formatNum(s)}
換手率: ${display}`;
}

function calcRR(){
  let e=parseFloat(document.getElementById("entry").value);
  if(!e)return;
  let sl=e*0.95,tp1=e*1.08,tp2=e*1.12;
  let risk=0.05,rew1=0.08,rew2=0.12;
  document.getElementById("rrOut").innerText=
`止損價(5%): RM ${sl.toFixed(4)}
止盈8%: RM ${tp1.toFixed(4)} (RR=${(rew1/risk).toFixed(2)})
止盈12%: RM ${tp2.toFixed(4)} (RR=${(rew2/risk).toFixed(2)})`;
}
</script>
</body>
</html>
